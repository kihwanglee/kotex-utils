%% File `hangulhook.sty`
%%
%% (C) Copyright 2006-2013 Dohyun Kin <nomos at ktug org>
%%                         Jin-Hwanho Cho <ChoF at ktug org>
%%
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%  http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2006/05/20 or later.
%%
%%  $Id: hangulhook.sty,v 1.2 2011/03/14 03:47:59 nomos Exp $
%%
%%  usage: \usehangulhook{가나다} or
%%         \begin{usehangulhook} ... \end{usehangulhook}
%%         after you have redefined \hangulhook
%%         eg. \def\hangulhook#1{(#1)}
%%
\bgroup\expandafter\expandafter\expandafter\egroup
\expandafter\ifx\csname ProvidesPackage\endcsname\relax
  \chardef\catcodeofATcharacter\catcode`\@ \catcode`\@ = 11
  \def\@firstofone#1{#1}
  \def\@gobble#1{}
  \def\:{\let\@sptoken= } \:  %
\else
  \ProvidesPackage{hangulhook}[2011/03/14 v0.5 hooking hangul syllable chars]
\fi

\let\hangulhook\@firstofone

\begingroup
\catcode`\A=11
\catcode`\0=12
\global\let\dhucs@cat@eleven=A
\global\let\dhucs@cat@twelve=0
\endgroup

\expandafter\def\expandafter\strip@character@meaning@prefix
  \detokenize{the character} #1{#1}
\expandafter\def\expandafter\strip@letter@meaning@prefix
  \detokenize{the letter} #1{#1}

\long\def\hook@appendtotoks@#1{\toks@\expandafter{\the\toks@ #1}}
\long\def\hook@@appendtotoks@@#1{\hook@appendtotoks@{#1}\hook@next@hook}
\def\hook@removeonetoken{\afterassignment\hook@next@hook\let\@tempa= }
\def\hook@appendtotoks@letter{%
  \edef\@tempb{\expandafter\strip@letter@meaning@prefix\meaning\xtxko@next}%
  \hook@inject@hook}
\def\hook@appendtotoks@character{%
  \edef\@tempb{\expandafter\strip@character@meaning@prefix\meaning\xtxko@next}%
  \hook@inject@hook}
\def\hook@inject@hook{%
  \count@\expandafter`\@tempb\relax
  \ifnum\count@>"ABFF \ifnum\count@<"D7A4
    \hook@appendtotoks@{\do@hangul@hook}%
  \fi\fi
}
  
\protected\def\usehangulhook{%
  \ifx\@currenvir\string@hookhangul
    \expandafter\@usehangulhookenv
  \else
    \expandafter\@usehangulhookcmd
  \fi}

\def\hook@next@hook{\futurelet\xtxko@next\hook@next@hook@next}

\long\def\@usehangulhookcmd#1{%
  \begingroup
  \toks@{}\hook@next@hook#1\@nil
  \the\toks@
  \endgroup}

\def\@usehangulhookenv{\toks@{}\@usehangulhookenv@}
\long\def\@usehangulhookenv@#1\end{%
  \hook@next@hook#1\@nil
  \futurelet\xtxko@next\hook@maybe@end}
\def\hook@maybe@end{%
  \ifx\xtxko@next\bgroup
    \expandafter\hook@probably@end
  \else
    \expandafter\@usehangulhookenv@
  \fi}
\def\hook@probably@end#1{%
  \def\@tempc{#1}%
  \ifx\@tempc\string@hookhangul
    \the\toks@\end{#1}%
  \else
    \hook@appendtotoks@{\end}\hook@appendtotoks@range{#1}%
    \expandafter\@usehangulhookenv@
  \fi}
\def\string@hookhangul{usehangulhook}

\def\hook@appendtotoks@range#1{%
  \begingroup
    \toks@{}\hook@next@hook#1\@nil
    \toks@\expandafter{\expandafter{\the\toks@}}% 
  \expandafter\endgroup
  \expandafter\toks@\expandafter\expandafter\expandafter
    {\expandafter\the\expandafter\toks@\the\toks@}}

\def\hook@append@range@loop#1{\hook@appendtotoks@range{#1}\hook@next@hook}

\def\hook@next@hook@next{% 
  \ifx\fi\xtxko@next \expandafter\let\csname xtxko@next\endcsname\relax \fi
  \ifx\ifx\xtxko@next \expandafter\let\csname xtxko@next\endcsname\relax \fi
  \ifx\xtxko@next\@nil
    \let\next\@gobble
  \else\if\noexpand\xtxko@next\relax
      \let\next\hook@@appendtotoks@@
  \else\ifx\bgroup\xtxko@next
    \let\next\hook@append@range@loop
  \else\ifx\@sptoken\xtxko@next
    \hook@appendtotoks@{ }\let\next\hook@removeonetoken
  \else\ifcat\dhucs@cat@eleven\xtxko@next
    \hook@appendtotoks@letter \let\next\hook@@appendtotoks@@
  \else\ifcat\dhucs@cat@twelve\xtxko@next
    \hook@appendtotoks@character \let\next\hook@@appendtotoks@@
  \else \let\next\hook@@appendtotoks@@
  \fi\fi\fi\fi\fi\fi
  \next}

%\def\do@hangul@hook#1{\hskip0pt plus .02em minus .02em \hangulhook{#1}}
\def\do@hangul@hook#1{\hangulhook{#1}}


\ifx\catcodeofATcharacter\undefined\else
  \catcode`\@\catcodeofATcharacter
\fi

\endinput
